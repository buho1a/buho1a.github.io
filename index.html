<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <title>Alarma PWA Persistente</title>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; background: #e9ecef; }
        .card { background: white; padding: 2.5rem; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 85%; max-width: 350px; text-align: center; }
        input[type="time"] { width: 100%; font-size: 2.5rem; border: 2px solid #ddd; border-radius: 12px; margin: 20px 0; text-align: center; color: #333; }
        button { width: 100%; padding: 18px; border-radius: 12px; border: none; background: #007bff; color: white; font-weight: bold; font-size: 1.1rem; cursor: pointer; transition: 0.3s; }
        button:active { transform: scale(0.98); }
        #status { margin-top: 20px; color: #666; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="card">
    <h2>Alarma PWA</h2>
    <input type="time" id="timeInput">
    <button id="mainBtn">Establecer Alarma</button>
    <p id="status">Cargando...</p>
</div>

<audio id="alarmSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" loop></audio>

<script>
    const mainBtn = document.getElementById('mainBtn');
    const timeInput = document.getElementById('timeInput');
    const status = document.getElementById('status');
    const sound = document.getElementById('alarmSound');
    let alarmInterval;

    // 1. REGISTRO Y CARGA INICIAL
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').then(() => {
            console.log("Service Worker registrado");
            
            // Revisar permisos de notificación
            if (Notification.permission === "default") {
                Notification.requestPermission();
            }

            // RECUPERAR HORA GUARDADA
            const savedTime = localStorage.getItem('alarma_guardada');
            if (savedTime) {
                timeInput.value = savedTime;
                status.innerText = "Recuperando alarma...";
                // Pequeño delay para asegurar que el SW esté listo
                setTimeout(() => programarAlarma(savedTime, false), 1000);
            } else {
                status.innerText = "Sin alarmas activas";
            }
        });
    }

    mainBtn.onclick = () => {
        if (mainBtn.innerText.includes("Detener")) {
            cancelarAlarma();
            return;
        }
        
        const time = timeInput.value;
        if (!time) return alert("Elige una hora");

        localStorage.setItem('alarma_guardada', time); // GUARDAR EN MEMORIA
        programarAlarma(time, true);
    };

    function programarAlarma(time, esNuevo) {
        const now = new Date();
        const [h, m] = time.split(':');
        let target = new Date();
        target.setHours(h, m, 0);
        
        if (target < now) target.setDate(target.getDate() + 1);
        const diff = target.getTime() - now.getTime();

        // Enviar al Service Worker para segundo plano
        if (navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({
                type: 'PROGRAMAR_ALARMA',
                ms: diff
            });
        }

        status.innerText = `Alarma configurada para las ${time}`;
        mainBtn.innerText = "Alarma Activada (Tocar para Cancelar)";
        mainBtn.style.background = "#6c757d";

        if(alarmInterval) clearInterval(alarmInterval);

        alarmInterval = setInterval(() => {
            const currentNow = new Date();
            const currentStr = currentNow.getHours().toString().padStart(2, '0') + ":" + 
                               currentNow.getMinutes().toString().padStart(2, '0');

            if (currentStr === time) {
                sound.play().catch(e => console.log("Esperando interacción para sonido"));
                mainBtn.innerText = "Detener Sonido";
                mainBtn.style.background = "red";
                clearInterval(alarmInterval);
            }
        }, 1000);
    }

    function cancelarAlarma() {
        sound.pause();
        sound.currentTime = 0;
        localStorage.removeItem('alarma_guardada'); // BORRAR MEMORIA
        if(alarmInterval) clearInterval(alarmInterval);
        location.reload();
    }
</script>
</body>
</html>
