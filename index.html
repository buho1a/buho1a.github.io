<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <title>Alarma PWA</title>
    <style>
        body { font-family: system-ui; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; background: #f4f7f6; }
        .card { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 80%; max-width: 400px; text-align: center; }
        input[type="time"] { width: 100%; font-size: 2rem; border: none; background: #eee; border-radius: 10px; margin: 20px 0; text-align: center; }
        button { width: 100%; padding: 15px; border-radius: 10px; border: none; background: #007bff; color: white; font-weight: bold; cursor: pointer; }
        #status { margin-top: 15px; color: #666; }
    </style>
</head>
<body>

<div class="card">
    <h2>Alarma Inteligente</h2>
    <input type="time" id="timeInput">
    <button id="mainBtn">Establecer Alarma</button>
    <p id="status">No programada</p>
</div>

<audio id="alarmSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" loop></audio>

<script>
    const mainBtn = document.getElementById('mainBtn');
    const timeInput = document.getElementById('timeInput');
    const status = document.getElementById('status');
    const sound = document.getElementById('alarmSound');
    let alarmInterval;

    // 1. Registrar el Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }

    // 2. Recuperar alarma guardada al cargar
    window.onload = () => {
        const savedTime = localStorage.getItem('myAlarm');
        if (savedTime) {
            timeInput.value = savedTime;
            setAlarm(savedTime);
        }
    };

    mainBtn.onclick = () => {
        if (mainBtn.innerText === "Detener") {
            stopAlarm();
            return;
        }
        const time = timeInput.value;
        if (time) {
            localStorage.setItem('myAlarm', time);
            setAlarm(time);
        }
    };

    function setAlarm(time) {
        status.innerText = `Alarma activa para las ${time}`;
        mainBtn.innerText = "Alarma Lista (Toca para cancelar)";
        
        alarmInterval = setInterval(() => {
            const now = new Date();
            const currentTime = now.getHours().toString().padStart(2, '0') + ":" + 
                              now.getMinutes().toString().padStart(2, '0');

            if (currentTime === time) {
                sound.play();
                status.innerText = "Â¡HORA CUMPLIDA!";
                mainBtn.innerText = "Detener";
                mainBtn.style.background = "red";
                clearInterval(alarmInterval);
            }
        }, 1000);
    }

    function stopAlarm() {
        sound.pause();
        sound.currentTime = 0;
        localStorage.removeItem('myAlarm');
        location.reload();
    }
</script>
</body>
</html>
